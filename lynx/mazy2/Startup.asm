include "Lynx.inc"
include "ZeroPage.inc"

ext InitVram
ext InitSound,SoundHandler
ext Main_

Interval equ 130
; Interval equ 80

dseg
TimerCount: 
    defb 0

cseg
Startup:
    lda #$08 | sta MAPCTL
	lda #$0d | sta DISPCTL
	lda #$9e | sta TIM0BKUP
	lda #$18 | sta TIM0CTLA
	lda #$68 | sta TlM2BKUP
	lda #$1f | sta TIM2CTLA
	lda #$29 | sta PBKUP

    jsr InitVram
    jsr InitSound
    sei
        lda #low EOI | sta NmiVector
        lda #high EOI | sta NmiVector+1
        lda #low Handler | sta IrqVector
        lda #high Handler | sta IrqVector+1

        lda #Interval-1 | sta TIM1BKUP
        lda #$1e | sta TIM1CTLA
        lda #2-1 | sta TIM3BKUP
        lda #$9f | sta TIM3CTLA
    cli
jmp Main_

Handler: public Handler
    pha
        lda INTSET
        and #$08
        if ne
            sta INTRST
            pha | phx | phy
                inc TimerCount
                jsr SoundHandler
            ply | plx | pla
        endif
    pla
EOI:
    cli
rti

; void WaitTimer(byte t);
dseg
WaitTimer_t:
    defb 0
cseg
WaitTimer_: public WaitTimer_
    pha
        sty WaitTimer_t
        do
            lda TimerCount
            cmp WaitTimer_t
        while cc | wend
        sei
            lda #0 | sta TimerCount
        cli
    pla
rts

SCB:
    defb $c5,$90,$00
    defw 0,Pattern+128*4
    defw 20,30
    defw $100,$100
    defb $01,$23,$45,$67,$89,$ab,$cd,$ef

Pattern:
;	sprite
	defb	$08, $00, $00, $00, $00, $00, $00, $00
	defb	$08, $00, $00, $77, $70, $00, $00, $00
	defb	$08, $00, $07, $77, $77, $00, $00, $00
	defb	$08, $00, $08, $78, $77, $00, $00, $00
	defb	$08, $00, $07, $77, $77, $00, $00, $00
	defb	$08, $00, $00, $77, $70, $00, $00, $00
	defb	$08, $00, $0b, $bb, $bb, $00, $00, $00
	defb	$08, $00, $b0, $bb, $b0, $b0, $00, $00
	defb	$08, $00, $e0, $dd, $d0, $e0, $00, $00
	defb	$08, $00, $0d, $d0, $dd, $00, $00, $00
	defb	$08, $00, $0d, $d0, $dd, $00, $00, $00
	defb	$08, $00, $0e, $e0, $ee, $00, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$08, $00, $00, $00, $00, $00, $00, $00
	defb	$08, $00, $00, $77, $70, $00, $00, $00
	defb	$08, $00, $07, $77, $77, $00, $00, $00
	defb	$08, $00, $08, $78, $77, $00, $00, $00
	defb	$08, $00, $07, $77, $77, $00, $00, $00
	defb	$08, $00, $00, $77, $70, $00, $00, $00
	defb	$08, $00, $00, $bb, $bb, $b0, $00, $00
	defb	$08, $00, $68, $bb, $b0, $e0, $00, $00
	defb	$08, $00, $00, $dd, $d0, $00, $00, $00
	defb	$08, $00, $0d, $dd, $dd, $e0, $00, $00
	defb	$08, $00, $0d, $d0, $dd, $e0, $00, $00
	defb	$08, $00, $ee, $00, $00, $00, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$08, $00, $00, $00, $00, $00, $00, $00
	defb	$08, $00, $00, $77, $70, $00, $00, $00
	defb	$08, $00, $07, $77, $77, $00, $00, $00
	defb	$08, $00, $08, $78, $77, $00, $00, $00
	defb	$08, $00, $07, $77, $77, $00, $00, $00
	defb	$08, $00, $00, $77, $70, $00, $00, $00
	defb	$08, $00, $00, $8b, $80, $00, $00, $00
	defb	$08, $00, $00, $8b, $80, $00, $00, $00
	defb	$08, $00, $00, $e8, $80, $00, $00, $00
	defb	$08, $00, $00, $8d, $d0, $00, $00, $00
	defb	$08, $00, $00, $dd, $e0, $00, $00, $00
	defb	$08, $00, $00, $ee, $00, $00, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$08, $00, $00, $00, $00, $00, $00, $00
	defb	$08, $00, $00, $77, $70, $00, $00, $00
	defb	$08, $00, $07, $77, $77, $00, $00, $00
	defb	$08, $00, $08, $78, $77, $00, $00, $00
	defb	$08, $00, $07, $77, $77, $00, $00, $00
	defb	$08, $00, $00, $77, $70, $00, $00, $00
	defb	$08, $00, $00, $bb, $b8, $b0, $00, $00
	defb	$08, $00, $eb, $bb, $b0, $e0, $00, $00
	defb	$08, $00, $00, $8d, $d0, $00, $00, $00
	defb	$08, $00, $00, $d8, $dd, $e0, $00, $00
	defb	$08, $00, $0d, $dd, $8d, $e0, $00, $00
	defb	$08, $00, $0e, $e0, $00, $00, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$08, $00, $00, $30, $30, $00, $00, $00
	defb	$08, $00, $00, $33, $33, $00, $00, $00
	defb	$08, $00, $03, $33, $33, $30, $00, $00
	defb	$08, $00, $03, $83, $83, $30, $00, $00
	defb	$08, $00, $03, $33, $33, $30, $00, $00
	defb	$08, $00, $03, $88, $83, $30, $00, $00
	defb	$08, $03, $30, $33, $33, $03, $30, $00
	defb	$08, $00, $33, $33, $33, $33, $00, $00
	defb	$08, $00, $03, $33, $33, $30, $00, $00
	defb	$08, $00, $00, $33, $33, $00, $00, $00
	defb	$08, $00, $00, $03, $33, $00, $00, $00
	defb	$08, $00, $00, $00, $33, $30, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$08, $00, $00, $00, $00, $00, $00, $00
	defb	$08, $00, $00, $30, $30, $00, $00, $00
	defb	$08, $00, $00, $33, $33, $00, $00, $00
	defb	$08, $00, $03, $33, $33, $30, $00, $00
	defb	$08, $00, $03, $83, $83, $30, $00, $00
	defb	$08, $00, $03, $33, $33, $30, $00, $00
	defb	$08, $00, $03, $88, $83, $30, $00, $00
	defb	$08, $00, $00, $33, $33, $00, $00, $00
	defb	$08, $00, $33, $33, $33, $33, $00, $00
	defb	$08, $03, $03, $33, $33, $30, $30, $00
	defb	$08, $00, $00, $33, $33, $30, $00, $00
	defb	$08, $00, $00, $03, $33, $33, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$08, $00, $00, $03, $03, $00, $00, $00
	defb	$08, $00, $00, $33, $33, $30, $00, $00
	defb	$08, $00, $03, $33, $33, $33, $00, $00
	defb	$08, $00, $03, $38, $38, $33, $00, $00
	defb	$08, $00, $03, $33, $33, $33, $00, $00
	defb	$08, $00, $03, $38, $88, $33, $00, $00
	defb	$08, $03, $30, $33, $33, $30, $33, $00
	defb	$08, $00, $33, $33, $33, $33, $30, $00
	defb	$08, $00, $03, $33, $33, $33, $00, $00
	defb	$08, $00, $03, $33, $33, $33, $00, $00
	defb	$08, $00, $00, $33, $33, $30, $00, $00
	defb	$08, $00, $00, $03, $33, $00, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$08, $00, $00, $00, $00, $00, $00, $00
	defb	$08, $00, $00, $03, $03, $00, $00, $00
	defb	$08, $00, $00, $33, $33, $30, $00, $00
	defb	$08, $00, $03, $33, $33, $33, $00, $00
	defb	$08, $00, $03, $38, $38, $33, $00, $00
	defb	$08, $00, $03, $33, $33, $33, $00, $00
	defb	$08, $00, $03, $38, $88, $33, $00, $00
	defb	$08, $00, $00, $33, $33, $30, $00, $00
	defb	$08, $00, $33, $33, $33, $33, $30, $00
	defb	$08, $03, $03, $33, $33, $33, $03, $00
	defb	$08, $00, $03, $33, $33, $33, $00, $00
	defb	$08, $00, $00, $33, $33, $30, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00
	defb	$00, $00, $00, $00, $00, $00, $00, $00

_WDC: public _WDC
phx
phy
plx
ply
stz $00
stz $12,x
stz $3456
stz $789a,x
trb $12
trb $3456
tsb $12
tsb $3456
bbr0 ZB1,_WDC
bbr1 $12,_WDC
bbr2 $12,_WDC
bbr3 $12,_WDC
bbr4 $12,_WDC
bbr5 $12,_WDC
bbr6 $12,_WDC
bbr7 $12,Startup
bbs0 $12,_WDC
bbs1 $12,_WDC
bbs2 $12,_WDC
bbs3 $12,_WDC
bbs4 $12,_WDC
bbs5 $12,_WDC
bbs6 $12,_WDC
bbs7 $12,Startup
rmb0 $12
rmb1 $12
rmb2 $12
rmb3 $12
rmb4 $12
rmb5 $12
rmb6 $12
rmb7 ZB0
smb0 $12
smb1 $12
smb2 $12
smb3 $12
smb4 $12
smb5 $12
smb6 $12
smb7 ZB0
stp
wai
adc ($12)
and ($12)
cmp ($12)
eor ($12)
lda ($12)
ora ($12)
sbc ($12)
sta (ZB0)
bit #$12
bit $34,x
bit $5678,x
inc a
dec a
jmp ($1234,x)
aaa:
if bs0 ZB0
    inc a
else
    dec a
endif

do
    inc a
while br1 $12
    dec a
wend
bra aaa
bra Startup
